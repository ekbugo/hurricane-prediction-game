<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hurricane Prediction Game - 6hr Timeframes</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 500px;
            border-radius: 0.5rem;
            width: 100%;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API Configuration
        const API_BASE_URL = 'https://hurricane-prediction-game-production.up.railway.app/api';

        function HurricaneGameApp() {
            const [gameState, setGameState] = useState(null);
            const [username, setUsername] = useState(localStorage.getItem('hurricaneUsername') || '');
            const [view, setView] = useState('predict');
            const [leaderboard, setLeaderboard] = useState([]);
            const [predictions, setPredictions] = useState({});
            const [submittedTimeframes, setSubmittedTimeframes] = useState({});
            const [currentTime, setCurrentTime] = useState(new Date());
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);

            // Fetch game state
            useEffect(() => {
                fetchGameState();
                const interval = setInterval(fetchGameState, 60000); // Every 60 seconds
                return () => clearInterval(interval);
            }, []);

            // Update current time every minute
            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentTime(new Date());
                }, 60000); // Update every 60 seconds
                return () => clearInterval(interval);
            }, []);

            async function fetchGameState() {
                try {
                    const response = await fetch(`${API_BASE_URL}/game/state`);
                    const data = await response.json();
                    setGameState(data);
                    
                    if (username) {
                        fetchUserPredictions();
                    }
                } catch (error) {
                    console.error('Error fetching game state:', error);
                }
            }

            async function fetchUserPredictions() {
                try {
                    const response = await fetch(`${API_BASE_URL}/predictions/${username}/${gameState?.id}`);
                    const data = await response.json();
                    
                    const submitted = {};
                    const preds = {};
                    
                    data.predictions.forEach(pred => {
                        submitted[pred.timeframe] = true;
                        preds[pred.timeframe] = {
                            lat: pred.predicted_lat,
                            lon: pred.predicted_lon,
                            windSpeed: pred.predicted_wind_speed,
                            pressure: pred.predicted_pressure
                        };
                    });
                    
                    setSubmittedTimeframes(submitted);
                    setPredictions(preds);
                } catch (error) {
                    console.error('Error fetching predictions:', error);
                }
            }

            async function fetchLeaderboard() {
                try {
                    const response = await fetch(`${API_BASE_URL}/leaderboard/${gameState?.id}`);
                    const data = await response.json();
                    setLeaderboard(data.leaderboard);
                } catch (error) {
                    console.error('Error fetching leaderboard:', error);
                }
            }

            useEffect(() => {
                if (view === 'leaderboard' && gameState) {
                    fetchLeaderboard();
                }
            }, [view, gameState]);

            // Initialize map
            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;

                const map = L.map(mapRef.current).setView([25.0, -80.0], 4);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                mapInstanceRef.current = map;

                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }
                };
            }, []);

            // Update map with storm data
            useEffect(() => {
                if (!mapInstanceRef.current || !gameState) return;

                const map = mapInstanceRef.current;
                
                // Clear existing layers except base tile layer
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        map.removeLayer(layer);
                    }
                });

                const bounds = [];
                const now = new Date();

                // Plot historical track (only released data)
                const trackPoints = [];
                gameState.timeframes.forEach((tf, index) => {
                    const tfTime = new Date(tf.time);
                    
                    // Only show data that has been released (6 hours after timeframe time)
                    const releaseTime = new Date(tfTime.getTime() + (6 * 60 * 60 * 1000));
                    if (now >= releaseTime) {
                        const color = tf.type === 'base' ? 'red' : 'blue';
                        const icon = L.divIcon({
                            html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                            className: '',
                            iconSize: [12, 12]
                        });

                        L.marker([tf.lat, tf.lon], { icon })
                            .bindPopup(`
                                <strong>${tf.timeframe} ${tf.type === 'base' ? 'Base' : 'Actual'}</strong><br>
                                Category ${tf.category}<br>
                                Wind: ${tf.windSpeed} mph<br>
                                Pressure: ${tf.pressure} mb
                            `)
                            .addTo(map);

                        trackPoints.push([tf.lat, tf.lon]);
                        bounds.push([tf.lat, tf.lon]);
                    }
                });

                if (trackPoints.length > 1) {
                    L.polyline(trackPoints, { color: 'blue', weight: 2, dashArray: '5, 5' }).addTo(map);
                }

                // Plot user predictions
                const predictionPoints = [];
                gameState.timeframes.filter(tf => tf.type !== 'base').forEach(tf => {
                    if (predictions[tf.timeframe]) {
                        const pred = predictions[tf.timeframe];
                        const icon = L.divIcon({
                            html: `<div style="background-color: green; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>`,
                            className: '',
                            iconSize: [12, 12]
                        });

                        L.marker([pred.lat, pred.lon], { icon })
                            .bindPopup(`
                                <strong>${tf.timeframe} Your Prediction</strong><br>
                                Wind: ${pred.windSpeed} mph<br>
                                Pressure: ${pred.pressure} mb
                            `)
                            .addTo(map);

                        predictionPoints.push([pred.lat, pred.lon]);
                        bounds.push([pred.lat, pred.lon]);
                    }
                });

                if (predictionPoints.length > 1) {
                    L.polyline(predictionPoints, { color: 'green', weight: 2, dashArray: '5, 5' }).addTo(map);
                }

                // Fit bounds if we have points
                if (bounds.length > 0) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }, [gameState, predictions]);

            // Helper function: Format time until timeframe opens
            function formatTimeUntil(timeframeTime) {
                const now = new Date();
                const tfTime = new Date(timeframeTime);
                const diff = tfTime - now;

                if (diff <= 0) return "Now";

                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

                return `${hours}h ${minutes}m`;
            }

            // NEW FUNCTION: Format time until timeframe closes
            function formatTimeUntilClose(timeframeTime) {
                const now = new Date();
                const tfTime = new Date(timeframeTime);
                
                // Each timeframe closes 6 hours after it opens
                const closeTime = new Date(tfTime.getTime() + (6 * 60 * 60 * 1000));
                
                const diff = closeTime - now;
                
                // If already closed or closing very soon
                if (diff <= 0) return "Closing now";
                
                // Calculate hours and minutes remaining
                const hours = Math.floor(diff / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                return `${hours}h ${minutes}m`;
            }

            // Determine which timeframe is currently active
            function getActiveTimeframe() {
                if (!gameState) return null;
                
                const now = new Date();
                
                for (const tf of gameState.timeframes) {
                    if (tf.type === 'base') continue;
                    
                    const tfTime = new Date(tf.time);
                    const unlockTime = new Date(tfTime.getTime() - (6 * 60 * 60 * 1000));
                    const lockTime = tfTime;
                    
                    if (now >= unlockTime && now < lockTime) {
                        return tf.timeframe;
                    }
                }
                
                return null;
            }

            async function submitPrediction(timeframe) {
                if (!username || !gameState || !predictions[timeframe]) {
                    alert('Please fill in all fields');
                    return;
                }

                const pred = predictions[timeframe];

                try {
                    const response = await fetch(`${API_BASE_URL}/predictions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username,
                            stormId: gameState.id,
                            timeframe,
                            lat: parseFloat(pred.lat),
                            lon: parseFloat(pred.lon),
                            windSpeed: parseInt(pred.windSpeed),
                            pressure: parseInt(pred.pressure)
                        })
                    });

                    if (response.ok) {
                        alert(`Prediction submitted for ${timeframe}!`);
                        setSubmittedTimeframes({ ...submittedTimeframes, [timeframe]: true });
                        fetchUserPredictions();
                    } else {
                        const error = await response.json();
                        alert(`Error: ${error.error}`);
                    }
                } catch (error) {
                    console.error('Error submitting prediction:', error);
                    alert('Failed to submit prediction');
                }
            }

            function handleUsernameSubmit(e) {
                e.preventDefault();
                if (username.trim()) {
                    localStorage.setItem('hurricaneUsername', username);
                    fetchUserPredictions();
                }
            }

            if (!gameState) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
                            <p className="text-xl text-gray-600">Loading hurricane data...</p>
                        </div>
                    </div>
                );
            }

            const activeTimeframe = getActiveTimeframe();

            return (
                <div className="container mx-auto px-4 py-8 max-w-7xl">
                    {/* Header */}
                    <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h1 className="text-4xl font-bold text-gray-800 mb-2">
                                    üåÄ Hurricane Prediction Challenge
                                </h1>
                                <p className="text-lg text-gray-600">
                                    {gameState.name} ‚Ä¢ {gameState.year}
                                </p>
                                <p className="text-sm text-gray-500 mt-1">
                                    Current Time: {currentTime.toLocaleString('en-US', { 
                                        timeZone: 'UTC',
                                        dateStyle: 'medium',
                                        timeStyle: 'short'
                                    })} UTC
                                </p>
                            </div>
                            <div className="flex gap-3">
                                <button
                                    onClick={() => setView('predict')}
                                    className={`px-6 py-3 rounded-lg font-bold transition-all ${
                                        view === 'predict' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    Predict
                                </button>
                                <button
                                    onClick={() => setView('leaderboard')}
                                    className={`px-6 py-3 rounded-lg font-bold transition-all ${
                                        view === 'leaderboard' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                                    }`}
                                >
                                    Leaderboard
                                </button>
                            </div>
                        </div>

                        {/* Username Input */}
                        {!username && (
                            <form onSubmit={handleUsernameSubmit} className="mt-4">
                                <div className="flex gap-2">
                                    <input
                                        type="text"
                                        value={username}
                                        onChange={(e) => setUsername(e.target.value)}
                                        placeholder="Enter your username"
                                        className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500"
                                        required
                                    />
                                    <button
                                        type="submit"
                                        className="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700"
                                    >
                                        Start Playing
                                    </button>
                                </div>
                            </form>
                        )}

                        {username && (
                            <div className="mt-4 flex items-center justify-between">
                                <p className="text-lg">
                                    <span className="font-semibold">Player:</span> <span className="text-blue-600">{username}</span>
                                </p>
                                <button
                                    onClick={() => {
                                        setUsername('');
                                        localStorage.removeItem('hurricaneUsername');
                                        setPredictions({});
                                        setSubmittedTimeframes({});
                                    }}
                                    className="text-sm text-red-600 hover:text-red-700"
                                >
                                    Change User
                                </button>
                            </div>
                        )}
                    </div>

                    {/* Main Content */}
                    {view === 'predict' ? (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            {/* Map */}
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Storm Track</h2>
                                <div ref={mapRef} id="map"></div>
                                <div className="mt-4 text-sm text-gray-600">
                                    <p><span className="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"></span>Base Position</p>
                                    <p><span className="inline-block w-3 h-3 bg-blue-500 rounded-full mr-2"></span>Actual Position (Released)</p>
                                    <p><span className="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"></span>Your Predictions</p>
                                </div>
                            </div>

                            {/* Prediction Form */}
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Make Your Predictions</h2>
                                
                                {!username ? (
                                    <div className="text-center py-12">
                                        <p className="text-lg text-gray-600">Please enter a username to start predicting</p>
                                    </div>
                                ) : (
                                    <div className="space-y-4">
                                        {/* Base Data (0000) - Read Only */}
                                        {gameState.timeframes
                                            .filter(tf => tf.type === 'base')
                                            .map(tf => (
                                                <div key={tf.timeframe} className="rounded-lg p-4 border-2 bg-gray-50 border-gray-300">
                                                    <h3 className="font-bold text-gray-800 mb-3">{tf.timeframe} Base</h3>
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-600 mb-1">Latitude</label>
                                                            <input
                                                                type="number"
                                                                value={tf.lat}
                                                                disabled
                                                                className="w-full px-3 py-2 border border-gray-300 rounded bg-white text-gray-700"
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-600 mb-1">Longitude</label>
                                                            <input
                                                                type="number"
                                                                value={tf.lon}
                                                                disabled
                                                                className="w-full px-3 py-2 border border-gray-300 rounded bg-white text-gray-700"
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-600 mb-1">Maximum Winds</label>
                                                            <input
                                                                type="number"
                                                                value={tf.windSpeed}
                                                                disabled
                                                                className="w-full px-3 py-2 border border-gray-300 rounded bg-white text-gray-700"
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="block text-sm font-medium text-gray-600 mb-1">Pressure</label>
                                                            <input
                                                                type="number"
                                                                value={tf.pressure}
                                                                disabled
                                                                className="w-full px-3 py-2 border border-gray-300 rounded bg-white text-gray-700"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        }

                                        {/* Prediction Timeframes */}
                                        {gameState.timeframes
                                            .filter(tf => tf.type !== 'base')
                                            .map(tf => {
                                                const now = new Date();
                                                const tfTime = new Date(tf.time);
                                                const unlockTime = new Date(tfTime.getTime() - (6 * 60 * 60 * 1000));
                                                
                                                const isActive = tf.timeframe === activeTimeframe;
                                                const isSubmitted = submittedTimeframes[tf.timeframe];
                                                const isLocked = !isActive;
                                                const isPast = now >= tfTime;

                                                const bgColor = isActive ? 'bg-green-50' : 'bg-gray-100';
                                                const borderColor = isActive ? 'border-green-500' : 'border-gray-300';

                                                return (
                                                    <div key={tf.timeframe} className={`rounded-lg p-4 border-2 ${bgColor} ${borderColor}`}>
                                                        <div className="flex items-center justify-between mb-3">
                                                            <h3 className="font-bold text-gray-800">{tf.timeframe} Prediction</h3>
                                                            
                                                            {/* NEW: Show "Closes in" for active timeframes */}
                                                            {isActive && !isSubmitted && (
                                                                <span className="text-sm bg-green-700 text-white px-3 py-1 rounded font-semibold">
                                                                    ‚è±Ô∏è Closes in: {formatTimeUntilClose(tf.time)}
                                                                </span>
                                                            )}
                                                            
                                                            {/* Show "Opens in" for future locked timeframes */}
                                                            {isLocked && !isPast && !isSubmitted && (
                                                                <span className="text-sm bg-gray-700 text-white px-3 py-1 rounded">
                                                                    Opens in: {formatTimeUntil(unlockTime)}
                                                                </span>
                                                            )}
                                                            
                                                            {/* Show submitted badge */}
                                                            {isSubmitted && (
                                                                <span className="text-sm bg-blue-600 text-white px-3 py-1 rounded">
                                                                    ‚úì Submitted
                                                                </span>
                                                            )}
                                                            
                                                            {/* Show closed/missed for past timeframes */}
                                                            {isPast && !isSubmitted && (
                                                                <span className="text-sm bg-red-600 text-white px-3 py-1 rounded">
                                                                    ‚è±Ô∏è Closed - Missed
                                                                </span>
                                                            )}
                                                        </div>

                                                        <div className="grid grid-cols-2 gap-3">
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-600 mb-1">Latitude</label>
                                                                <input
                                                                    type="number"
                                                                    step="0.1"
                                                                    value={predictions[tf.timeframe]?.lat || ''}
                                                                    onChange={(e) => setPredictions({
                                                                        ...predictions,
                                                                        [tf.timeframe]: { ...predictions[tf.timeframe], lat: e.target.value }
                                                                    })}
                                                                    disabled={isLocked || isSubmitted}
                                                                    placeholder="e.g., 26.5"
                                                                    className={`w-full px-3 py-2 border border-gray-300 rounded ${
                                                                        isLocked || isSubmitted ? 'bg-gray-200 text-gray-600' : 'bg-white'
                                                                    }`}
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-600 mb-1">Longitude</label>
                                                                <input
                                                                    type="number"
                                                                    step="0.1"
                                                                    value={predictions[tf.timeframe]?.lon || ''}
                                                                    onChange={(e) => setPredictions({
                                                                        ...predictions,
                                                                        [tf.timeframe]: { ...predictions[tf.timeframe], lon: e.target.value }
                                                                    })}
                                                                    disabled={isLocked || isSubmitted}
                                                                    placeholder="e.g., -82.0"
                                                                    className={`w-full px-3 py-2 border border-gray-300 rounded ${
                                                                        isLocked || isSubmitted ? 'bg-gray-200 text-gray-600' : 'bg-white'
                                                                    }`}
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-600 mb-1">Maximum Winds</label>
                                                                <input
                                                                    type="number"
                                                                    value={predictions[tf.timeframe]?.windSpeed || ''}
                                                                    onChange={(e) => setPredictions({
                                                                        ...predictions,
                                                                        [tf.timeframe]: { ...predictions[tf.timeframe], windSpeed: e.target.value }
                                                                    })}
                                                                    disabled={isLocked || isSubmitted}
                                                                    placeholder="e.g., 135"
                                                                    className={`w-full px-3 py-2 border border-gray-300 rounded ${
                                                                        isLocked || isSubmitted ? 'bg-gray-200 text-gray-600' : 'bg-white'
                                                                    }`}
                                                                />
                                                            </div>
                                                            <div>
                                                                <label className="block text-sm font-medium text-gray-600 mb-1">Pressure</label>
                                                                <input
                                                                    type="number"
                                                                    value={predictions[tf.timeframe]?.pressure || ''}
                                                                    onChange={(e) => setPredictions({
                                                                        ...predictions,
                                                                        [tf.timeframe]: { ...predictions[tf.timeframe], pressure: e.target.value }
                                                                    })}
                                                                    disabled={isLocked || isSubmitted}
                                                                    placeholder="e.g., 945"
                                                                    className={`w-full px-3 py-2 border border-gray-300 rounded ${
                                                                        isLocked || isSubmitted ? 'bg-gray-200 text-gray-600' : 'bg-white'
                                                                    }`}
                                                                />
                                                            </div>
                                                        </div>

                                                        {isActive && !isSubmitted && (
                                                            <button
                                                                onClick={() => submitPrediction(tf.timeframe)}
                                                                className="w-full mt-3 px-4 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition-all"
                                                            >
                                                                Submit Prediction
                                                            </button>
                                                        )}
                                                    </div>
                                                );
                                            })
                                        }
                                    </div>
                                )}
                            </div>
                        </div>
                    ) : (
                        /* Leaderboard View */
                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">üèÜ Leaderboard</h2>
                            {leaderboard.length === 0 ? (
                                <p className="text-center text-gray-600 py-12">No scores yet. Be the first to predict!</p>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead>
                                            <tr className="bg-gray-100 border-b-2 border-gray-300">
                                                <th className="px-4 py-3 text-left font-bold">Rank</th>
                                                <th className="px-4 py-3 text-left font-bold">Player</th>
                                                <th className="px-4 py-3 text-right font-bold">Total Score</th>
                                                <th className="px-4 py-3 text-center font-bold">Predictions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {leaderboard.map((entry, index) => (
                                                <tr key={index} className={`border-b border-gray-200 ${
                                                    entry.username === username ? 'bg-blue-50 font-semibold' : ''
                                                }`}>
                                                    <td className="px-4 py-3">
                                                        {index === 0 && 'ü•á'}
                                                        {index === 1 && 'ü•à'}
                                                        {index === 2 && 'ü•â'}
                                                        {index > 2 && `#${index + 1}`}
                                                    </td>
                                                    <td className="px-4 py-3">{entry.username}</td>
                                                    <td className="px-4 py-3 text-right font-mono">{entry.total_score.toLocaleString()}</td>
                                                    <td className="px-4 py-3 text-center">{entry.prediction_count}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<HurricaneGameApp />, document.getElementById('root'));
    </script>
</body>
</html>
