<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hurricane Prediction Game</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 500px;
            border-radius: 0.5rem;
            width: 100%;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .tab-active {
            border-bottom: 3px solid #3B82F6;
            color: #3B82F6;
        }
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #3B82F6 0%, #1E40AF 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            z-index: 1000;
        }
        .loading-message {
            font-size: 1.25rem;
            color: white;
            font-weight: 600;
            margin: 0.5rem 0;
            opacity: 0;
            animation: fadeInOut 2s ease-in-out infinite;
        }
        .loading-message:nth-child(1) {
            animation-delay: 0s;
        }
        .loading-message:nth-child(2) {
            animation-delay: 0.6s;
        }
        .loading-message:nth-child(3) {
            animation-delay: 1.2s;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0; transform: translateY(10px); }
            50% { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Configuration
        const API_BASE_URL = 'https://hurricane-prediction-game-production.up.railway.app/api';

        function HurricaneGameApp() {
            const [gameState, setGameState] = useState(null);
            const [userPredictions, setUserPredictions] = useState([]);
            const [username, setUsername] = useState('');
            const [currentPrediction, setCurrentPrediction] = useState({
                lat: '',
                lon: '',
                windSpeed: '',
                pressure: ''
            });
            const [view, setView] = useState('predict');
            const [map, setMap] = useState(null);
            const [mapLoading, setMapLoading] = useState(true);
            const [loading, setLoading] = useState(true);
            
            // Leaderboard state
            const [leaderboardTab, setLeaderboardTab] = useState('current'); // current, alltime, bystorm, personal, badges
            const [currentStormLeaderboard, setCurrentStormLeaderboard] = useState([]);
            const [allTimeLeaderboard, setAllTimeLeaderboard] = useState([]);
            const [stormHistory, setStormHistory] = useState([]);
            const [personalStats, setPersonalStats] = useState(null);
            const [participants, setParticipants] = useState([]);
            
            // Badge state
            const [userBadges, setUserBadges] = useState([]);
            const [allBadges, setAllBadges] = useState([]);
            const [badgeProgress, setBadgeProgress] = useState(null);

            // Profile state
            const [userProfile, setUserProfile] = useState(null);
            const [editMode, setEditMode] = useState(false);
            const [profileForm, setProfileForm] = useState({
                display_name: '',
                avatar_url: '',
                bio: '',
                location: ''
            });

            // Fetch game state
            useEffect(() => {
                const fetchGameState = async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/game/state`);
                        const data = await response.json();
                        setGameState(data);
                        setLoading(false);
                    } catch (error) {
                        console.error('Error fetching game state:', error);
                        setLoading(false);
                    }
                };
                
                fetchGameState();
                const interval = setInterval(fetchGameState, 30000);
                return () => clearInterval(interval);
            }, []);

            // Fetch user predictions
            useEffect(() => {
                if (!username || !gameState) return;
                
                const fetchPredictions = async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/predictions/user/${username}`);
                        const data = await response.json();
                        setUserPredictions(data.predictions || []);
                    } catch (error) {
                        console.error('Error fetching predictions:', error);
                    }
                };
                
                fetchPredictions();
            }, [username, gameState]);

            // Fetch user profile when username changes or when viewing profile
            useEffect(() => {
                if (!username || (view !== 'profile' && view !== 'predict' && view !== 'leaderboard')) return;

                const fetchProfile = async () => {
                    try {
                        const response = await fetch(`${API_BASE_URL}/profile/${username}`);
                        const data = await response.json();
                        setUserProfile(data);
                        setProfileForm({
                            display_name: data.profile.display_name || '',
                            avatar_url: data.profile.avatar_url || '',
                            bio: data.profile.bio || '',
                            location: data.profile.location || ''
                        });
                    } catch (error) {
                        console.error('Error fetching profile:', error);
                    }
                };

                fetchProfile();
            }, [username, view]);

            // Fetch leaderboard data based on active tab
            useEffect(() => {
                if (!gameState || view !== 'leaderboard') return;
                
                const fetchLeaderboardData = async () => {
                    try {
                        // Fetch current storm data and participants in parallel
                        const [currentData, partData] = await Promise.all([
                            fetch(`${API_BASE_URL}/leaderboard/${gameState.storm.id}`).then(r => r.json()),
                            fetch(`${API_BASE_URL}/participants/${gameState.storm.id}`).then(r => r.json())
                        ]);
                        
                        setCurrentStormLeaderboard(currentData.leaderboard || []);
                        setParticipants(partData.participants || []);
                        
                        // Fetch tab-specific data
                        if (leaderboardTab === 'alltime') {
                            const allTimeData = await fetch(`${API_BASE_URL}/leaderboard/all-time/global`).then(r => r.json());
                            setAllTimeLeaderboard(allTimeData.leaderboard || []);
                        } else if (leaderboardTab === 'bystorm') {
                            const historyData = await fetch(`${API_BASE_URL}/leaderboard/by-storm/all`).then(r => r.json());
                            setStormHistory(historyData.storms || []);
                        } else if (leaderboardTab === 'personal' && username) {
                            const statsData = await fetch(`${API_BASE_URL}/user/${username}/stats`).then(r => r.json());
                            setPersonalStats(statsData);
                        } else if (leaderboardTab === 'badges' && username) {
                            const [badgesData, allBadgesData, progressData] = await Promise.all([
                                fetch(`${API_BASE_URL}/user/${username}/badges`).then(r => r.json()),
                                fetch(`${API_BASE_URL}/badges/definitions`).then(r => r.json()),
                                fetch(`${API_BASE_URL}/user/${username}/badge-progress`).then(r => r.json())
                            ]);
                            setUserBadges(badgesData.badges || []);
                            setAllBadges(allBadgesData.badges || []);
                            setBadgeProgress(progressData.progress || null);
                        }
                    } catch (error) {
                        console.error('Error fetching leaderboard:', error);
                    }
                };
                
                fetchLeaderboardData();
            }, [gameState, view, leaderboardTab, username]);

            // Initialize map
            useEffect(() => {
                if (map || !gameState) return;
                
                const mapElement = document.getElementById('map');
                if (!mapElement || typeof L === 'undefined') return;
                
                try {
                    setMapLoading(true);
                    const newMap = L.map('map').setView([25.0, -80.0], 5);
                    
                    const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 10,
                        minZoom: 3
                    }).addTo(newMap);
                    
                    // Hide loading overlay when tiles are loaded
                    tileLayer.on('load', () => {
                        setTimeout(() => setMapLoading(false), 500); // Small delay for smooth transition
                    });

                    setMap(newMap);
                } catch (error) {
                    console.error('Error initializing map:', error);
                    setMapLoading(false);
                }
            }, [map, gameState]);

            // Update map with storm track
            useEffect(() => {
                if (!map || !gameState || !gameState.timeframes) return;

                map.eachLayer((layer) => {
                    if (!(layer instanceof L.TileLayer)) {
                        map.removeLayer(layer);
                    }
                });

                const getCategoryColor = (cat) => {
                    const colors = {
                        0: '#6B7280',
                        1: '#FBBF24',
                        2: '#F59E0B',
                        3: '#EF4444',
                        4: '#DC2626',
                        5: '#7C3AED'
                    };
                    return colors[cat] || '#6B7280';
                };

                const now = new Date();
                const gameStart = new Date(gameState.storm.gameStart);
                const hoursSinceStart = (now - gameStart) / (1000 * 60 * 60);
                
                const releasedTimeframes = gameState.timeframes.filter(tf => {
                    if (tf.type === 'base') return true;
                    if (tf.timeframe === '0600') return hoursSinceStart >= 6;
                    if (tf.timeframe === '1200') return hoursSinceStart >= 12;
                    if (tf.timeframe === '1800') return hoursSinceStart >= 18;
                    if (tf.timeframe === '0000') return hoursSinceStart >= 24;
                    return false;
                });

                const releasedPoints = releasedTimeframes.map(tf => [tf.lat, tf.lon]);
                if (releasedPoints.length > 1) {
                    L.polyline(releasedPoints, { color: '#4B5563', weight: 4, opacity: 0.8 })
                        .addTo(map);
                }

                releasedTimeframes.forEach((tf) => {
                    const color = getCategoryColor(tf.category);
                    const icon = L.divIcon({
                        className: 'custom-icon',
                        html: `<div style="background-color: ${color}; width: ${tf.type === 'base' ? 24 : 16}px; height: ${tf.type === 'base' ? 24 : 16}px; border-radius: 50%; border: 3px solid white;"></div>`,
                        iconSize: [tf.type === 'base' ? 24 : 16, tf.type === 'base' ? 24 : 16]
                    });
                    
                    L.marker([tf.lat, tf.lon], { icon }).addTo(map)
                        .bindPopup(`<strong>${tf.timeframe} ${tf.type === 'base' ? '(Base)' : '(Actual)'}</strong><br>Cat ${tf.category}<br>${tf.windSpeed} mph<br>${tf.pressure} mb`);
                });

                if (userPredictions && userPredictions.length > 0) {
                    const predictionPoints = userPredictions.map(pred => [pred.predicted_lat, pred.predicted_lon]);
                    
                    if (predictionPoints.length > 1) {
                        L.polyline(predictionPoints, { 
                            color: '#10B981', 
                            weight: 4, 
                            opacity: 0.9, 
                            dashArray: '10, 10' 
                        }).addTo(map);
                    }
                    
                    userPredictions.forEach(pred => {
                        const icon = L.divIcon({
                            className: 'custom-icon',
                            html: `<div style="background-color: #10B981; width: 18px; height: 18px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);"></div>`,
                            iconSize: [18, 18]
                        });
                        
                        L.marker([pred.predicted_lat, pred.predicted_lon], { icon }).addTo(map)
                            .bindPopup(`<strong>Your ${pred.timeframe} Prediction</strong><br>${pred.predicted_wind_speed} mph<br>${pred.predicted_pressure} mb`);
                    });
                }
                
                const allMapPoints = [...releasedPoints];
                if (userPredictions && userPredictions.length > 0) {
                    userPredictions.forEach(pred => {
                        if (pred.predicted_lat && pred.predicted_lon) {
                            allMapPoints.push([pred.predicted_lat, pred.predicted_lon]);
                        }
                    });
                }
                
                if (allMapPoints.length > 0) {
                    try {
                        map.fitBounds(allMapPoints, { padding: [50, 50], maxZoom: 8 });
                    } catch (error) {
                        console.log('Could not fit bounds:', error);
                    }
                }
            }, [map, gameState, userPredictions]);

            const handlePredictionChange = (field, value) => {
                setCurrentPrediction({
                    ...currentPrediction,
                    [field]: value
                });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!username) {
                    alert('Please enter your username');
                    return;
                }

                if (!currentPrediction.lat || !currentPrediction.lon || !currentPrediction.windSpeed || !currentPrediction.pressure) {
                    alert('Please fill all prediction fields');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/predictions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username: username,
                            stormId: gameState.storm.id,
                            timeframe: gameState.activeTimeframe,
                            lat: parseFloat(currentPrediction.lat),
                            lon: parseFloat(currentPrediction.lon),
                            windSpeed: parseInt(currentPrediction.windSpeed),
                            pressure: parseInt(currentPrediction.pressure)
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to submit');
                    }

                    alert('Prediction submitted successfully!');
                    
                    setCurrentPrediction({ lat: '', lon: '', windSpeed: '', pressure: '' });
                    
                    const predResponse = await fetch(`${API_BASE_URL}/predictions/user/${username}`);
                    const predData = await predResponse.json();
                    setUserPredictions(predData.predictions || []);
                    
                } catch (error) {
                    alert(`Error: ${error.message}`);
                }
            };

            const getTimeframeStatus = (timeframe) => {
                if (!gameState) return 'locked';
                
                const userPred = userPredictions.find(p => p.timeframe === timeframe);
                if (userPred) return 'submitted';
                
                if (timeframe === gameState.activeTimeframe) return 'active';
                
                return 'locked';
            };

            const formatTimeUntilUnlock = (hours) => {
                const h = Math.floor(hours);
                const m = Math.floor((hours - h) * 60);
                return `${h}h ${m}m`;
            };

            const renderLeaderboardContent = () => {
                if (leaderboardTab === 'current') {
                    return (
                        <div>
                            <h3 className="font-bold text-gray-800 mb-3 text-lg">üìä {gameState.storm.name} Leaderboard</h3>
                            {currentStormLeaderboard.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-6xl mb-4">‚è≥</div>
                                    <p className="text-gray-600 text-lg font-semibold">No scores yet!</p>
                                    <p className="text-gray-500 text-sm mt-2">
                                        Scores will appear once timeframes close and predictions are scored.
                                    </p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {currentStormLeaderboard.map((entry, index) => (
                                        <div
                                            key={entry.username}
                                            className={`flex items-center gap-4 p-4 rounded-lg transition-all ${
                                                entry.username === username ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50 hover:bg-gray-100'
                                            }`}
                                        >
                                            <div className="text-3xl font-bold w-12 text-center">
                                                {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}
                                            </div>
                                            <div className="flex-1">
                                                <div className="font-bold text-lg">
                                                    {entry.username}
                                                    {entry.username === username && <span className="ml-2 text-sm text-green-600">(You)</span>}
                                                </div>
                                                <div className="text-sm text-gray-600">
                                                    {entry.predictions_count} prediction{entry.predictions_count !== 1 ? 's' : ''} scored
                                                    {entry.total_score > 0 && ` ‚Ä¢ Avg: ${Math.round(entry.total_score / entry.predictions_count)} pts`}
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-2xl font-bold text-blue-600">
                                                    {entry.total_score || 0}
                                                </div>
                                                <div className="text-sm text-gray-600">points</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    );
                } else if (leaderboardTab === 'alltime') {
                    return (
                        <div>
                            <h3 className="font-bold text-gray-800 mb-3 text-lg">üåç All-Time Rankings</h3>
                            {allTimeLeaderboard.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-6xl mb-4">‚è≥</div>
                                    <p className="text-gray-600 text-lg font-semibold">No all-time data yet!</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {allTimeLeaderboard.map((entry, index) => (
                                        <div
                                            key={entry.username}
                                            className={`flex items-center gap-4 p-4 rounded-lg transition-all ${
                                                entry.username === username ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50 hover:bg-gray-100'
                                            }`}
                                        >
                                            <div className="text-3xl font-bold w-12 text-center">
                                                {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}
                                            </div>
                                            <div className="flex-1">
                                                <div className="font-bold text-lg">
                                                    {entry.username}
                                                    {entry.username === username && <span className="ml-2 text-sm text-green-600">(You)</span>}
                                                </div>
                                                <div className="text-sm text-gray-600">
                                                    {entry.storms_played} storm{entry.storms_played !== 1 ? 's' : ''} ‚Ä¢ 
                                                    {entry.scored_predictions} predictions ‚Ä¢ 
                                                    Avg: {entry.avg_score} pts
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <div className="text-2xl font-bold text-purple-600">
                                                    {entry.total_score.toLocaleString()}
                                                </div>
                                                <div className="text-sm text-gray-600">total points</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    );
                } else if (leaderboardTab === 'bystorm') {
                    return (
                        <div>
                            <h3 className="font-bold text-gray-800 mb-3 text-lg">üìÖ Storm History</h3>
                            {stormHistory.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="text-6xl mb-4">‚è≥</div>
                                    <p className="text-gray-600 text-lg font-semibold">No historical storms yet!</p>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {stormHistory.map((storm) => (
                                        <div key={storm.stormId} className="bg-gray-50 rounded-lg p-6">
                                            <h4 className="font-bold text-xl text-gray-800 mb-4">
                                                üåÄ {storm.stormName} {storm.stormYear && `(${storm.stormYear})`}
                                            </h4>
                                            <div className="space-y-2">
                                                {storm.leaderboard.slice(0, 5).map((entry, index) => (
                                                    <div key={entry.username} className="flex items-center gap-3 p-3 bg-white rounded-lg">
                                                        <div className="text-xl font-bold w-8 text-center">
                                                            {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `#${index + 1}`}
                                                        </div>
                                                        <div className="flex-1">
                                                            <div className="font-semibold">{entry.username}</div>
                                                            <div className="text-xs text-gray-500">
                                                                {entry.predictions_count} predictions ‚Ä¢ Avg: {entry.avg_score} pts
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-lg font-bold text-blue-600">{entry.total_score}</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    );
                } else if (leaderboardTab === 'personal') {
                    if (!username) {
                        return (
                            <div className="text-center py-12">
                                <div className="text-6xl mb-4">üë§</div>
                                <p className="text-gray-600 text-lg font-semibold">Enter your username</p>
                                <p className="text-gray-500 text-sm mt-2">
                                    Go to the Predict tab and enter your username to see your stats!
                                </p>
                            </div>
                        );
                    }
                    
                    if (!personalStats || !personalStats.stats || personalStats.stats.total_predictions === 0) {
                        return (
                            <div className="text-center py-12">
                                <div className="text-6xl mb-4">üìä</div>
                                <p className="text-gray-600 text-lg font-semibold">No stats yet, {username}!</p>
                                <p className="text-gray-500 text-sm mt-2">
                                    Make some predictions to see your personal statistics.
                                </p>
                            </div>
                        );
                    }
                    
                    const stats = personalStats.stats;
                    const rank = personalStats.globalRank;
                    
                    return (
                        <div>
                            <h3 className="font-bold text-gray-800 mb-6 text-2xl">üìä Your Statistics - {username}</h3>
                            
                            {/* Overall Stats Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-6">
                                    <div className="text-sm font-semibold text-blue-700 mb-2">GLOBAL RANK</div>
                                    <div className="text-4xl font-bold text-blue-900">
                                        {rank.rank ? `#${rank.rank}` : 'N/A'}
                                    </div>
                                </div>
                                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-6">
                                    <div className="text-sm font-semibold text-green-700 mb-2">TOTAL SCORE</div>
                                    <div className="text-4xl font-bold text-green-900">
                                        {stats.total_score?.toLocaleString() || 0}
                                    </div>
                                </div>
                                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-6">
                                    <div className="text-sm font-semibold text-purple-700 mb-2">AVG SCORE</div>
                                    <div className="text-4xl font-bold text-purple-900">
                                        {stats.avg_score || 0}
                                    </div>
                                </div>
                            </div>
                            
                            {/* Additional Stats */}
                            <div className="bg-gray-50 rounded-lg p-6 mb-6">
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <div className="text-xs text-gray-500 mb-1">Storms Played</div>
                                        <div className="text-2xl font-bold text-gray-800">{stats.storms_played || 0}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500 mb-1">Predictions Made</div>
                                        <div className="text-2xl font-bold text-gray-800">{stats.total_predictions || 0}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500 mb-1">Best Score</div>
                                        <div className="text-2xl font-bold text-green-600">{stats.best_score || 0}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500 mb-1">Worst Score</div>
                                        <div className="text-2xl font-bold text-red-600">{stats.worst_score || 0}</div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* Best Predictions */}
                            {personalStats.bestPredictions && personalStats.bestPredictions.length > 0 && (
                                <div>
                                    <h4 className="font-bold text-gray-800 mb-3 text-lg">üèÜ Your Best Predictions</h4>
                                    <div className="space-y-3">
                                        {personalStats.bestPredictions.map((pred, index) => (
                                            <div key={index} className="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg p-4">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div className="font-bold text-lg">{pred.stormName} - {pred.timeframe}</div>
                                                    <div className="text-2xl font-bold text-orange-600">{pred.score} pts</div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 text-sm text-gray-600">
                                                    <div>Predicted: {parseFloat(pred.predicted_lat).toFixed(1)}¬∞N, {Math.abs(parseFloat(pred.predicted_lon)).toFixed(1)}¬∞W</div>
                                                    <div>Actual: {pred.actual_lat ? parseFloat(pred.actual_lat).toFixed(1) : 'N/A'}¬∞N, {pred.actual_lon ? Math.abs(parseFloat(pred.actual_lon)).toFixed(1) : 'N/A'}¬∞W</div>
                                                    <div>Winds: {pred.predicted_wind_speed} mph (actual: {pred.actual_wind_speed || 'N/A'} mph)</div>
                                                    <div>Pressure: {pred.predicted_pressure} mb (actual: {pred.actual_pressure || 'N/A'} mb)</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                } else if (leaderboardTab === 'badges') {
                    if (!username) {
                        return (
                            <div className="text-center py-12 bg-gray-50 rounded-lg">
                                <div className="text-6xl mb-4">üë§</div>
                                <h3 className="text-xl font-bold text-gray-700 mb-2">Enter Your Username</h3>
                                <p className="text-gray-600">Go to the Predict tab and enter your username to view your badges!</p>
                            </div>
                        );
                    }
                    
                    return (
                        <div>
                            <h3 className="text-2xl font-bold text-gray-800 mb-6">üèÖ Your Badges</h3>
                            
                            {/* Stats Summary */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                                    <div className="text-3xl font-bold">{userBadges.length}</div>
                                    <div className="text-sm opacity-90">Badges Earned</div>
                                </div>
                                <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                                    <div className="text-3xl font-bold">{allBadges.length - userBadges.length}</div>
                                    <div className="text-sm opacity-90">Badges to Unlock</div>
                                </div>
                                <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-lg p-4 text-white">
                                    <div className="text-3xl font-bold">
                                        {allBadges.length > 0 ? Math.round((userBadges.length / allBadges.length) * 100) : 0}%
                                    </div>
                                    <div className="text-sm opacity-90">Completion</div>
                                </div>
                            </div>
                            
                            {/* Badge Grid */}
                            {userBadges.length === 0 ? (
                                <div className="text-center py-12 bg-gray-50 rounded-lg">
                                    <div className="text-6xl mb-4">üèÖ</div>
                                    <h3 className="text-xl font-bold text-gray-700 mb-2">No Badges Yet!</h3>
                                    <p className="text-gray-600">Keep making predictions to earn your first badge.</p>
                                    <p className="text-gray-500 text-sm mt-2">
                                        Make a prediction and wait for it to be scored to earn "First Steps" üë∂
                                    </p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                                    {userBadges.map(badge => (
                                        <div
                                            key={badge.badge_id}
                                            className="bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-xl p-4 border-4 border-yellow-500 shadow-lg hover:scale-105 transition-transform"
                                        >
                                            <div className="text-center text-5xl mb-2">{badge.icon}</div>
                                            <div className="text-center font-bold text-sm text-gray-800">{badge.name}</div>
                                            <div className="text-center text-xs text-gray-600 mt-1">{badge.description}</div>
                                            <div className="text-center text-xs font-bold text-yellow-700 mt-2 uppercase">
                                                {badge.tier}
                                            </div>
                                            {badge.points_value > 0 && (
                                                <div className="text-center text-xs font-bold text-green-700 mt-1">
                                                    +{badge.points_value} pts
                                                </div>
                                            )}
                                            <div className="text-center text-xs text-gray-500 mt-2">
                                                {new Date(badge.earned_at).toLocaleDateString()}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            
                            {/* Progress Section */}
                            {badgeProgress && (
                                <div className="mt-8">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">üìä Badge Progress</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="bg-white rounded-lg p-4 border-2 border-gray-200">
                                            <div className="font-bold text-gray-800 mb-2">Total Predictions</div>
                                            <div className="text-3xl font-bold text-blue-600">
                                                {badgeProgress.milestones.predictions}
                                            </div>
                                            <div className="text-xs text-gray-500 mt-2">
                                                Next milestone: {
                                                    badgeProgress.milestones.predictions < 10 ? '10' :
                                                    badgeProgress.milestones.predictions < 50 ? '50' :
                                                    badgeProgress.milestones.predictions < 100 ? '100' :
                                                    '500'
                                                } predictions
                                            </div>
                                        </div>
                                        
                                        <div className="bg-white rounded-lg p-4 border-2 border-gray-200">
                                            <div className="font-bold text-gray-800 mb-2">Total Points</div>
                                            <div className="text-3xl font-bold text-purple-600">
                                                {badgeProgress.milestones.points.toLocaleString()}
                                            </div>
                                            <div className="text-xs text-gray-500 mt-2">
                                                Next milestone: {
                                                    badgeProgress.milestones.points < 5000 ? '5,000' :
                                                    badgeProgress.milestones.points < 25000 ? '25,000' :
                                                    badgeProgress.milestones.points < 50000 ? '50,000' :
                                                    '100,000'
                                                } points
                                            </div>
                                        </div>
                                        
                                        <div className="bg-white rounded-lg p-4 border-2 border-gray-200">
                                            <div className="font-bold text-gray-800 mb-2">Unique Storms</div>
                                            <div className="text-3xl font-bold text-green-600">
                                                {badgeProgress.milestones.storms}
                                            </div>
                                            <div className="text-xs text-gray-500 mt-2">
                                                Next milestone: {badgeProgress.milestones.storms < 5 ? '5' : '12'} storms
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                }
            };

            if (loading) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-2xl">Loading game...</div>
                    </div>
                );
            }

            if (!gameState) {
                return (
                    <div className="flex items-center justify-center min-h-screen">
                        <div className="text-2xl text-red-600">No active storm</div>
                    </div>
                );
            }

            return (
                <div className="container mx-auto px-4 py-8 max-w-7xl">
                    {/* Header */}
                    <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div className="flex items-center justify-between">
                            <div className="flex-1">
                                <h1 className="text-4xl font-bold text-gray-800">üåÄ {gameState.storm.name}</h1>
                                <p className="text-gray-600">24-Hour Prediction Challenge</p>
                                <p className="text-sm text-gray-500 mt-2">
                                    üïê Current Time: {new Date().toLocaleString('en-US', { 
                                        dateStyle: 'medium',
                                        timeStyle: 'short'
                                    })} (Your Local Time)
                                </p>
                            </div>
                            <div className="flex gap-4">
                                <button
                                    onClick={() => setView('predict')}
                                    className={`px-6 py-3 rounded-lg font-bold transition-all ${view === 'predict' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Predict
                                </button>
                                <button
                                    onClick={() => setView('leaderboard')}
                                    className={`px-6 py-3 rounded-lg font-bold transition-all ${view === 'leaderboard' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Leaderboard
                                </button>
                                <button
                                    onClick={() => setView('profile')}
                                    className={`px-6 py-3 rounded-lg font-bold transition-all ${view === 'profile' ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}
                                >
                                    Profile
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Map */}
                    <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <h2 className="text-xl font-bold text-gray-800 mb-4">Storm Track</h2>
                        <div style={{position: 'relative'}}>
                            <div id="map"></div>
                            {mapLoading && (
                                <div className="loading-overlay">
                                    <div className="loading-message">üåÄ Loading hurricane data...</div>
                                    <div className="loading-message">üó∫Ô∏è Preparing map tiles...</div>
                                    <div className="loading-message">üìä Fetching predictions...</div>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Main Content */}
                    {view === 'predict' ? (
                        <div key="predict-view" className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">Submit Your Prediction</h2>
                            
                            {/* Username */}
                            <div className="mb-6">
                                <label className="block text-sm font-bold text-gray-700 mb-2">Username *</label>
                                <input
                                    type="text"
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                    placeholder="Enter your username"
                                />
                            </div>

                            {/* Info Box */}
                            <div className="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
                                <p className="text-sm text-green-800">
                                    <strong>üìç Enter predictions for the next available timeframe.</strong><br/>
                                    Your predictions will appear as green points on the map with a dashed line connecting them.
                                </p>
                            </div>

                            {/* Timeframes - keeping existing prediction form */}
                            <div className="space-y-4">
                                {gameState.timeframes.map((tf, index) => {
                                    if (tf.type === 'base') {
                                        return (
                                            <div key={tf.timeframe} className="bg-gray-100 rounded-lg p-4">
                                                <div className="flex items-center justify-between mb-3">
                                                    <h3 className="font-bold text-gray-800">{tf.timeframe} Base</h3>
                                                </div>
                                                <div className="grid grid-cols-4 gap-4">
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">Latitude</label>
                                                        <input type="text" value={tf.lat} disabled className="w-full px-3 py-2 bg-white border border-gray-300 rounded text-gray-500" />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">Longitude</label>
                                                        <input type="text" value={tf.lon} disabled className="w-full px-3 py-2 bg-white border border-gray-300 rounded text-gray-500" />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">Maximum Winds</label>
                                                        <input type="text" value={tf.windSpeed} disabled className="w-full px-3 py-2 bg-white border border-gray-300 rounded text-gray-500" />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium text-gray-600 mb-1">Pressure</label>
                                                        <input type="text" value={tf.pressure} disabled className="w-full px-3 py-2 bg-white border border-gray-300 rounded text-gray-500" />
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    }

                                    const status = getTimeframeStatus(tf.timeframe);
                                    const isActive = status === 'active';
                                    const isSubmitted = status === 'submitted';
                                    const isLocked = status === 'locked';

                                    const now = new Date();
                                    const gameStart = new Date(gameState.storm.gameStart);
                                    const hoursSinceStart = (now - gameStart) / (1000 * 60 * 60);
                                    
                                    let isPastTimeframe = false;
                                    let hoursUntilUnlock = 0;
                                    
                                    if (tf.timeframe === '0600') {
                                        isPastTimeframe = hoursSinceStart >= 6;
                                        hoursUntilUnlock = 6 - hoursSinceStart;
                                    } else if (tf.timeframe === '1200') {
                                        isPastTimeframe = hoursSinceStart >= 12;
                                        hoursUntilUnlock = 12 - hoursSinceStart;
                                    } else if (tf.timeframe === '1800') {
                                        isPastTimeframe = hoursSinceStart >= 18;
                                        hoursUntilUnlock = 18 - hoursSinceStart;
                                    } else if (tf.timeframe === '0000') {
                                        isPastTimeframe = hoursSinceStart >= 24;
                                        hoursUntilUnlock = 24 - hoursSinceStart;
                                    }

                                    const bgColor = isActive ? 'bg-green-50' : 'bg-gray-100';
                                    const borderColor = isActive ? 'border-green-500' : 'border-gray-300';

                                    return (
                                        <div key={tf.timeframe} className={`rounded-lg p-4 border-2 ${bgColor} ${borderColor}`}>
                                            <div className="flex items-center justify-between mb-3">
                                                <h3 className="font-bold text-gray-800">{tf.timeframe} Prediction</h3>
                                                {isLocked && !isSubmitted && !isPastTimeframe && hoursUntilUnlock > 0 && (
                                                    <span className="text-sm bg-gray-700 text-white px-3 py-1 rounded">
                                                        Opens in: {formatTimeUntilUnlock(hoursUntilUnlock)}
                                                    </span>
                                                )}
                                                {isLocked && !isSubmitted && isPastTimeframe && (
                                                    <span className="text-sm bg-red-600 text-white px-3 py-1 rounded">‚è±Ô∏è Closed - Missed</span>
                                                )}
                                                {isSubmitted && (
                                                    <span className="text-sm bg-blue-600 text-white px-3 py-1 rounded">‚úì Submitted</span>
                                                )}
                                            </div>
                                            <div className="grid grid-cols-4 gap-4">
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">Latitude</label>
                                                    <input
                                                        type="number"
                                                        step="0.1"
                                                        value={isActive ? currentPrediction.lat : (isSubmitted ? userPredictions.find(p => p.timeframe === tf.timeframe)?.predicted_lat : '')}
                                                        onChange={(e) => isActive && handlePredictionChange('lat', e.target.value)}
                                                        disabled={!isActive}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded"
                                                        placeholder="e.g., 26.5"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">Longitude</label>
                                                    <input
                                                        type="number"
                                                        step="0.1"
                                                        value={isActive ? currentPrediction.lon : (isSubmitted ? userPredictions.find(p => p.timeframe === tf.timeframe)?.predicted_lon : '')}
                                                        onChange={(e) => isActive && handlePredictionChange('lon', e.target.value)}
                                                        disabled={!isActive}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded"
                                                        placeholder="e.g., -82.0"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">Maximum Winds</label>
                                                    <input
                                                        type="number"
                                                        value={isActive ? currentPrediction.windSpeed : (isSubmitted ? userPredictions.find(p => p.timeframe === tf.timeframe)?.predicted_wind_speed : '')}
                                                        onChange={(e) => isActive && handlePredictionChange('windSpeed', e.target.value)}
                                                        disabled={!isActive}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded"
                                                        placeholder="e.g., 135"
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-xs font-medium text-gray-700 mb-1">Pressure</label>
                                                    <input
                                                        type="number"
                                                        value={isActive ? currentPrediction.pressure : (isSubmitted ? userPredictions.find(p => p.timeframe === tf.timeframe)?.predicted_pressure : '')}
                                                        onChange={(e) => isActive && handlePredictionChange('pressure', e.target.value)}
                                                        disabled={!isActive}
                                                        className="w-full px-3 py-2 border border-gray-300 rounded"
                                                        placeholder="e.g., 945"
                                                    />
                                                </div>
                                            </div>
                                            {isActive && (
                                                <div className="mt-4">
                                                    <button
                                                        onClick={handleSubmit}
                                                        className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-all"
                                                    >
                                                        Submit Prediction
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ) : view === 'profile' ? (
                        <div key="profile-view" className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">üë§ User Profile</h2>

                            {!username ? (
                                <div className="text-center py-12">
                                    <p className="text-gray-600 mb-4">Please enter your username in the Predict tab to view your profile.</p>
                                    <button
                                        onClick={() => setView('predict')}
                                        className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg"
                                    >
                                        Go to Predict
                                    </button>
                                </div>
                            ) : !userProfile ? (
                                <div className="text-center py-12">
                                    <div className="animate-pulse text-gray-600">Loading profile...</div>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {/* Profile Header */}
                                    <div className="flex items-start justify-between border-b pb-6">
                                        <div className="flex items-center gap-6">
                                            <div className="w-24 h-24 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-4xl">
                                                {userProfile.profile.avatar_url || 'üë§'}
                                            </div>
                                            <div>
                                                <h3 className="text-2xl font-bold text-gray-800">
                                                    {userProfile.profile.display_name || username}
                                                </h3>
                                                <p className="text-gray-600">@{username}</p>
                                                {userProfile.profile.location && (
                                                    <p className="text-gray-500 mt-1">üìç {userProfile.profile.location}</p>
                                                )}
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => setEditMode(!editMode)}
                                            className="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg"
                                        >
                                            {editMode ? 'Cancel' : 'Edit Profile'}
                                        </button>
                                    </div>

                                    {editMode ? (
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Display Name</label>
                                                <input
                                                    type="text"
                                                    value={profileForm.display_name}
                                                    onChange={(e) => setProfileForm({...profileForm, display_name: e.target.value})}
                                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                                    placeholder="Enter display name"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Avatar (emoji or icon)</label>
                                                <div className="flex gap-2">
                                                    <input
                                                        type="text"
                                                        value={profileForm.avatar_url}
                                                        onChange={(e) => setProfileForm({...profileForm, avatar_url: e.target.value})}
                                                        className="flex-1 px-4 py-3 border border-gray-300 rounded-lg"
                                                        placeholder="Enter an emoji (e.g., üå™Ô∏è, üåä, ‚ö°)"
                                                    />
                                                    <div className="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center text-2xl">
                                                        {profileForm.avatar_url || 'üë§'}
                                                    </div>
                                                </div>
                                                <p className="text-xs text-gray-500 mt-1">Suggested: üå™Ô∏è üåä ‚ö° üåÄ üî± ‚≠ê üéØ üèÜ</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Bio</label>
                                                <textarea
                                                    value={profileForm.bio}
                                                    onChange={(e) => setProfileForm({...profileForm, bio: e.target.value})}
                                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                                    rows="3"
                                                    placeholder="Tell us about yourself..."
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Location</label>
                                                <input
                                                    type="text"
                                                    value={profileForm.location}
                                                    onChange={(e) => setProfileForm({...profileForm, location: e.target.value})}
                                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg"
                                                    placeholder="e.g., Miami, FL"
                                                />
                                            </div>
                                            <button
                                                onClick={async () => {
                                                    try {
                                                        const response = await fetch(`${API_BASE_URL}/profile/${username}`, {
                                                            method: 'PUT',
                                                            headers: { 'Content-Type': 'application/json' },
                                                            body: JSON.stringify(profileForm)
                                                        });
                                                        const data = await response.json();
                                                        if (data.success) {
                                                            setUserProfile({...userProfile, profile: data.profile});
                                                            setEditMode(false);
                                                            alert('Profile updated successfully!');
                                                        }
                                                    } catch (error) {
                                                        console.error('Error updating profile:', error);
                                                        alert('Failed to update profile');
                                                    }
                                                }}
                                                className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg"
                                            >
                                                Save Changes
                                            </button>
                                        </div>
                                    ) : (
                                        <>
                                            {/* Bio Section */}
                                            {userProfile.profile.bio && (
                                                <div className="bg-gray-50 rounded-lg p-4">
                                                    <h4 className="font-bold text-gray-700 mb-2">About</h4>
                                                    <p className="text-gray-600">{userProfile.profile.bio}</p>
                                                </div>
                                            )}

                                            {/* Prediction Style Stats */}
                                            {userProfile.predictionStyle && userProfile.predictionStyle.totalPredictions > 0 && (
                                                <div>
                                                    <h4 className="text-xl font-bold text-gray-800 mb-4">üìä Prediction Style Analysis</h4>

                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4">
                                                            <div className="text-3xl font-bold text-blue-600">{userProfile.predictionStyle.style}</div>
                                                            <div className="text-sm text-gray-600">Forecaster Type</div>
                                                        </div>
                                                        <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4">
                                                            <div className="text-3xl font-bold text-green-600">{userProfile.predictionStyle.totalPredictions}</div>
                                                            <div className="text-sm text-gray-600">Total Predictions</div>
                                                        </div>
                                                    </div>

                                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                                        <div className="bg-white border-2 border-gray-200 rounded-lg p-4">
                                                            <div className="text-lg font-bold text-gray-800">{userProfile.predictionStyle.trackAccuracy}</div>
                                                            <div className="text-sm text-gray-600">Track Accuracy</div>
                                                            <div className="text-xs text-gray-500 mt-1">Avg: {userProfile.predictionStyle.avgDistance} NM</div>
                                                        </div>
                                                        <div className="bg-white border-2 border-gray-200 rounded-lg p-4">
                                                            <div className="text-lg font-bold text-gray-800">{userProfile.predictionStyle.intensityAccuracy}</div>
                                                            <div className="text-sm text-gray-600">Intensity Accuracy</div>
                                                            <div className="text-xs text-gray-500 mt-1">Wind: ¬±{userProfile.predictionStyle.avgWindError} mph</div>
                                                        </div>
                                                        <div className="bg-white border-2 border-gray-200 rounded-lg p-4">
                                                            <div className="text-lg font-bold text-gray-800">{userProfile.predictionStyle.favoriteTimeframe}</div>
                                                            <div className="text-sm text-gray-600">Favorite Timeframe</div>
                                                            <div className="text-xs text-gray-500 mt-1">{userProfile.predictionStyle.timeframeCounts[userProfile.predictionStyle.favoriteTimeframe]} predictions</div>
                                                        </div>
                                                    </div>

                                                    <div className="bg-purple-50 rounded-lg p-4 mb-6">
                                                        <h5 className="font-bold text-purple-900 mb-3">Prediction Tendencies</h5>
                                                        <div className="space-y-2 text-sm">
                                                            <div className="flex items-center justify-between">
                                                                <span className="text-gray-700">Track Bias:</span>
                                                                <span className="font-semibold text-purple-700">{userProfile.predictionStyle.tendencies.trackBias}</span>
                                                            </div>
                                                            <div className="flex items-center justify-between">
                                                                <span className="text-gray-700">Intensity Bias:</span>
                                                                <span className="font-semibold text-purple-700">{userProfile.predictionStyle.tendencies.intensityBias}</span>
                                                            </div>
                                                            <div className="flex items-center justify-between">
                                                                <span className="text-gray-700">Consistency:</span>
                                                                <span className="font-semibold text-purple-700">{userProfile.predictionStyle.tendencies.consistency}</span>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div className="bg-yellow-50 rounded-lg p-4">
                                                        <h5 className="font-bold text-yellow-900 mb-3">Score Breakdown</h5>
                                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                                            <div>
                                                                <div className="text-gray-600">Avg Track Score</div>
                                                                <div className="text-2xl font-bold text-yellow-700">{userProfile.predictionStyle.avgTrackScore}</div>
                                                            </div>
                                                            <div>
                                                                <div className="text-gray-600">Avg Intensity Score</div>
                                                                <div className="text-2xl font-bold text-yellow-700">{userProfile.predictionStyle.avgIntensityScore}</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}

                                            {userProfile.predictionStyle && userProfile.predictionStyle.totalPredictions === 0 && (
                                                <div className="text-center py-8 bg-gray-50 rounded-lg">
                                                    <p className="text-gray-600">No predictions yet. Make some predictions to see your style analysis!</p>
                                                    <button
                                                        onClick={() => setView('predict')}
                                                        className="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg"
                                                    >
                                                        Make Your First Prediction
                                                    </button>
                                                </div>
                                            )}
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                    ) : (
                        <div key="leaderboard-view" className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-2xl font-bold text-gray-800 mb-6">üèÜ Leaderboards</h2>
                            
                            {/* Participants Count - Only show for Current Storm tab */}
                            {leaderboardTab === 'current' && participants.length > 0 && (
                                <div className="mb-6 p-4 bg-blue-50 rounded-lg">
                                    <h3 className="font-bold text-blue-900 mb-3">
                                        üë• {participants.length} Participant{participants.length !== 1 ? 's' : ''} Competing in {gameState.storm.name}
                                    </h3>
                                    <div className="flex flex-wrap gap-2">
                                        {participants.map(p => (
                                            <span key={p.username} className="bg-white px-3 py-1 rounded-full text-sm text-gray-700 border border-blue-200">
                                                {p.username} ({p.predictions_count})
                                            </span>
                                        ))}
                                    </div>
                                    <p className="text-xs text-blue-700 mt-2">
                                        Numbers show how many predictions each user has submitted for this storm
                                    </p>
                                </div>
                            )}
                            
                            {/* Leaderboard Tabs */}
                            <div className="flex gap-2 mb-6 border-b border-gray-200 overflow-x-auto">
                                <button
                                    onClick={() => setLeaderboardTab('current')}
                                    className={`px-6 py-3 font-semibold transition-all whitespace-nowrap ${
                                        leaderboardTab === 'current' ? 'tab-active' : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    Current Storm
                                </button>
                                <button
                                    onClick={() => setLeaderboardTab('alltime')}
                                    className={`px-6 py-3 font-semibold transition-all whitespace-nowrap ${
                                        leaderboardTab === 'alltime' ? 'tab-active' : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    All-Time
                                </button>
                                <button
                                    onClick={() => setLeaderboardTab('bystorm')}
                                    className={`px-6 py-3 font-semibold transition-all whitespace-nowrap ${
                                        leaderboardTab === 'bystorm' ? 'tab-active' : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    By Storm
                                </button>
                                <button
                                    onClick={() => setLeaderboardTab('personal')}
                                    className={`px-6 py-3 font-semibold transition-all whitespace-nowrap ${
                                        leaderboardTab === 'personal' ? 'tab-active' : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    My Stats
                                </button>
                                <button
                                    onClick={() => setLeaderboardTab('badges')}
                                    className={`px-6 py-3 font-semibold transition-all whitespace-nowrap ${
                                        leaderboardTab === 'badges' ? 'tab-active' : 'text-gray-600 hover:text-gray-800'
                                    }`}
                                >
                                    üèÖ My Badges
                                </button>
                            </div>
                            
                            {/* Leaderboard Content */}
                            {renderLeaderboardContent()}
                            
                            {/* Scoring Legend */}
                            <div className="mt-8 p-4 bg-blue-50 rounded-lg">
                                <h3 className="font-bold text-blue-900 mb-2">üìä Scoring System</h3>
                                <div className="text-sm text-blue-800 space-y-1">
                                    <p><strong>Track Score (0-1000 pts):</strong> Based on distance error from actual position</p>
                                    <p><strong>Intensity Score (0-1000 pts):</strong> Based on wind speed + pressure accuracy</p>
                                    <p><strong>Total per timeframe:</strong> 0-2000 pts</p>
                                    <p><strong>Total per storm:</strong> 0-8000 pts (4 timeframes)</p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<HurricaneGameApp />, document.getElementById('root'));
    </script>
</body>
</html>
